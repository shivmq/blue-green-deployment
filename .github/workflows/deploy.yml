name: Blue Green Deployment

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ${{ vars.github_runner }}

    steps:
    - uses: actions/checkout@v4

    - name: Build image
      run: docker build -t fastapi-green ./app

    - name: Deploy GREEN
      run: |
        ssh ${{ vars.INFRA_VM_IP }} "
          docker rm -f app-green || true
          docker run -d --name app-green -p 8002:8000 -e APP_VERSION=green fastapi-green
        "

    - name: Health check
      run: |
        ssh ${{ vars.INFRA_VM_IP }} "sleep 5 && curl -f http://127.0.0.1:8002/health"

    - name: Switch traffic
      run: |
        ssh ${{ vars.INFRA_VM_IP }} "
          sudo sed -i 's/8001/8002/' /etc/nginx/conf.d/app-upstream.conf
          sudo nginx -t
          sudo systemctl reload nginx
        "
